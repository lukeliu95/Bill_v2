---
name: customer-match
description: |
  基于 ICP 画像（.features/find-customer/data/ 下的 MD 文件），在企业数据库中匹配潜在客户。
  使用 Bash 工具执行多条件组合查询，输出匹配企业列表。

  触发场景：find-customer 输出 ICP 画像后手动触发，
  或用户说"帮我匹配客户"、"跑一下筛选"时手动触发。
---

# Customer Match

读取 ICP 筛选条件，在企业数据库中匹配潜在客户。

## 核心原则

1. **逐条过滤**：用管道串联多条件，逐步缩小范围
2. **宽进严出**：先用硬性条件（地域、员工数）过滤，再用软性条件（事業内容关键词）精选
3. **实时写入**：匹配结果立刻写入 `.features/customer-match/data/`

## 数据格式

企业数据在 `data/enterprises_10000.md`，每行一条记录：
```
法人番号：X | 企業名：X | 住所：X | 設立日：X | 資本金：X | 従業員数：X | 代表者：X | 事業内容：X | ウェブサイト：X | アクティビティ数：X | カテゴリID：X
```

## 流程

### Step 1: 读取 ICP 画像

读取 `.features/find-customer/data/` 目录下**最新的 MD 文件**（按文件名时间戳排序）。

**读取方式**：
1. 用 Glob 找到 `.features/find-customer/data/*.md` 下所有文件
2. 取文件名时间戳最新的一个
3. 读取文件，提取 `## 筛选条件（JSON）` 下的 JSON code block
4. 解析 JSON 中的筛选条件

**解析字段**：
- `prefectureIds` → 地域过滤
- `minEmployeeNumber` / `maxEmployeeNumber` → 员工数范围
- `minEstablishmentAt` / `maxEstablishmentAt` → 成立日范围
- `minCapitalStock` / `maxCapitalStock` → 资本金范围
- `categoryCodes` → 行业关键词映射（不能直接匹配カテゴリID）
- `enhancedConditions` → 事業内容关键词

**异常处理**：如果 `.features/find-customer/data/` 下没有文件，提示用户先运行 `/find-customer` 生成 ICP 画像。

### Step 2: 构建 Bash 查询管道

用 Bash 工具执行 grep + awk 管道查询。按以下顺序逐步过滤：

#### 2a. 地域过滤（grep 住所）

将 `prefectureIds` 映射为都道府県名：

```
1=北海道, 2=青森, 3=岩手, 4=宮城, 5=秋田, 6=山形, 7=福島,
8=茨城, 9=栃木, 10=群馬, 11=埼玉, 12=千葉, 13=東京, 14=神奈川,
15=新潟, 16=富山, 17=石川, 18=福井, 19=山梨, 20=長野,
21=岐阜, 22=静岡, 23=愛知, 24=三重, 25=滋賀, 26=京都,
27=大阪, 28=兵庫, 29=奈良, 30=和歌山,
31=鳥取, 32=島根, 33=岡山, 34=広島, 35=山口,
36=徳島, 37=香川, 38=愛媛, 39=高知,
40=福岡, 41=佐賀, 42=長崎, 43=熊本, 44=大分, 45=宮崎, 46=鹿児島, 47=沖縄
```

示例（関西）：
```bash
grep -E '住所：(三重|滋賀|京都|大阪|兵庫|奈良|和歌山)' data/enterprises_10000.md
```

**注意**：北海道没有"県"，直接用"北海道"匹配；東京用"東京"；大阪用"大阪"；京都用"京都"。

#### 2b. 员工数过滤（awk）

提取従業員数字段，做范围比较：
```bash
| awk -F'|' '{
  for(i=1;i<=NF;i++) {
    if($i ~ /従業員数/) {
      gsub(/[^0-9]/,"",$i);
      n=int($i);
      if(n >= MIN && n <= MAX) print $0
    }
  }
}'
```

将 MIN/MAX 替换为 result.json 中的 `minEmployeeNumber`/`maxEmployeeNumber`。
如果没有设置上限，MAX 用 999999。
如果没有设置下限，MIN 用 0。

#### 2c. 成立日过滤（awk，可选）

如果 result.json 有 `minEstablishmentAt` 或 `maxEstablishmentAt`：
```bash
| awk -F'|' '{
  for(i=1;i<=NF;i++) {
    if($i ~ /設立日/) {
      gsub(/[ 設立日：]/,"",$i);
      if($i != "" && $i >= "MIN_DATE" && $i <= "MAX_DATE") print $0
    }
  }
}'
```

**注意**：部分企业設立日为空，空值的记录跳过（不过滤也不排除，根据数据质量决定）。
`maxEstablishmentAt` 的含义是"成立于此日期之前"，即筛选老企业（成立年数 ≥ X 年）。

#### 2d. 资本金过滤（awk，可选）

如果 result.json 有 `minCapitalStock` 或 `maxCapitalStock`：
```bash
| awk -F'|' '{
  for(i=1;i<=NF;i++) {
    if($i ~ /資本金/) {
      gsub(/[^0-9]/,"",$i);
      n=int($i);
      if(n >= MIN && n <= MAX) print $0
    }
  }
}'
```

#### 2e. 行业关键词过滤（grep，可选/辅助）

**重要**：数据中的 `カテゴリID` 是平台内部编号，不是日本標準産業分類代码，不能用 `categoryCodes` 直接匹配。

行业过滤改用事業内容关键词匹配。将 `categoryCodes` 映射为关键词：

| categoryCodes | 关键词（grep 事業内容） |
|--------------|----------------------|
| E（製造業） | 製造\|メーカー\|工場\|生産 |
| G（情報通信業） | IT\|ソフトウェア\|SaaS\|システム\|情報\|アプリ\|クラウド |
| I（卸売業、小売業） | 卸売\|小売\|商社\|販売\|流通 |
| D（建設業） | 建設\|工事\|建築\|土木 |
| J（金融業、保険業） | 銀行\|証券\|保険\|金融\|ファイナンス |
| K（不動産業） | 不動産\|賃貸\|物件 |
| L（専門・技術サービス業） | コンサル\|法律\|会計\|広告\|デザイン\|調査\|マーケティング |
| H（運輸業） | 運輸\|物流\|配送\|倉庫\|ロジスティクス |
| M（宿泊業、飲食） | ホテル\|旅館\|飲食\|レストラン |
| P（医療、福祉） | 医療\|病院\|介護\|福祉\|クリニック |

示例：
```bash
| grep -iE '事業内容：.*(IT|ソフトウェア|SaaS|システム|製造|メーカー|金融|コンサル)'
```

**この条件は補助フィルタ**：事業内容の記載が不十分な企業もあるため、行業関鍵詞にヒットしない企業を一律除外するのはリスクがある。以下の戦略を取る：
- 硬性条件（地域・従業員数）で絞った後、**結果が多すぎる（50件+）場合のみ**行業キーワードフィルタを追加
- 結果が少ない（50件以下）場合は行業フィルタなしで全件出力

#### 2f. enhancedConditions 関連キーワード（補助スコアリング用）

`enhancedConditions` の `name` や `description` から抽出したキーワードは、マッチ後のスコアリング・優先順位付けに使う。クエリ段階では使わない（データベースの事業内容記載だけでは判断できないため）。

### Step 3: 実行と出力

1. **Bash でクエリ実行**：上記のパイプラインを一つの Bash コマンドとして実行
2. **結果をカウント**：`wc -l` で件数確認
3. **件数に応じた対応**：
   - 0件 → 条件を緩和して再クエリ（従業員数範囲を広げる、地域を広げる）
   - 1-50件 → そのまま出力
   - 51-200件 → 行業キーワードフィルタを追加して絞り込み
   - 200件+ → 条件を厳しくして再クエリ

4. **結果ファイル出力**：`.features/customer-match/data/YYYY-MM-DD-HHmmss.md` に書き込む

出力フォーマット：
```markdown
# 客户匹配结果
> 匹配时间：YYYY-MM-DD-HHmmss
> 筛选条件：result.json の parseExplanation を引用
> 匹配数：N 件

## 筛选条件摘要
- 地域：XX
- 员工数：XX ~ XX
- 行业关键词：XX
- 成立日：XX

## 匹配企业列表

| # | 企業名 | 住所 | 従業員数 | 設立日 | 事業内容 | ウェブサイト |
|---|--------|------|----------|--------|----------|-------------|
| 1 | XX | XX | XX | XX | XX | XX |
```

5. **MEMORY.md 更新**：`.features/customer-match/MEMORY.md` の快速索引に追記
6. **用户展示**：マッチ件数と上位結果（最大20件）を対話で表示

## 条件緩和戦略

0件ヒットの場合、以下の順序で条件を緩和：

1. 従業員数範囲を ±50% に拡大
2. 地域を隣接エリアに拡大（例：関西 → 関西+中部）
3. 成立日条件を削除
4. 資本金条件を削除

緩和した場合は必ずユーザーに報告する。

## 注意事項

- カテゴリID は平台内部编号、日本標準産業分類ではない → categoryCodes で直接マッチ不可
- 事業内容が空や汎用的な記載の企業もある → 行業フィルタは補助的に使う
- 設立日が空の企業がある → 設立日フィルタ時は空値を除外しない（保留する）
- 結果は必ず `.features/customer-match/data/` に保存する（実時写入原則）
